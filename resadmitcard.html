<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="assest/ChatGPT_Image_Feb_9__2026__01_04_36_PM-removebg-preview.png">
    <title>FSI Download ID Card</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<style>
    .btn-2 {
        background-color: #0f6db5;
        color: white;
    }
</style>

<body>
    <div class="head">
        <img src="assest/ChatGPT_Image_Feb_9__2026__01_04_36_PM-removebg-preview.png" alt="">
        <i class="fa-solid fa-bars"></i>
    </div>

    <div class="menu">
        <div class="logo">
            <img src="assest/ChatGPT_Image_Feb_9__2026__01_04_36_PM-removebg-preview.png" alt="">
            <i class="fa-solid fa-xmark"></i>
        </div>

        <div class="menuss">
            <div class="select-menu">

                <a href="#">Home</a>
                <a href="#">About</a>

                <div class="">
                    <div class="courses">
                        <a href="#">Courses</a>
                        <i class="fa-solid fa-angle-down"></i>
                    </div>


                    <div class="course-item">
                        <h1>25252</h1>
                    </div>
                </div>

                <a href="#">Campus</a>
                <a href="result.html">Check Result</a>

            </div>

            <div class="lines">
                <hr class="line-1">
            </div>

            <div class="but">
                <a href="index.html"><button>Enroll Now</button></a>
            </div>
        </div>
    </div>

    <section>

        <div class="part-1">
            <div class="head-one">
                <i class="fa-solid fa-graduation-cap"></i>
                <i class="fa-solid fa-angle-right"></i>
                <h3>Download ID Card</h3>
            </div>

            <div class="head-second">
                <h1>Download Your ID Card</h1>
                <p>Enter your CNIC to download your student ID card</p>
            </div>
        </div>

        <div id="part-sec">
            <div class="part-sec">
                <a href="index.html" class="btn btn-1">
                    <i class="fa-solid fa-clipboard-list"></i>
                    <h3>Registration Form</h3>
                </a>
                <a href="resadmitcard.html" class="btn btn-2">
                    <i class="fa-regular fa-address-card"></i>
                    <h3>Download ID Card</h3>
                </a>
                <a href="result.html" class="btn btn-3">
                    <i class="fa-solid fa-square-poll-horizontal"></i>
                    <h3>Result</h3>
                </a>
            </div>
        </div>

    </section>

    <!-- section 2 -->

    <section>

        <div class="id-heading">
            <h2>Download ID Card</h2>
            <p>Enter the CNIC you provided during form submission</p>
        </div>

        <div class="cnin-no">
            <div class="input">
                <h3>CNIC Number <span>*</span></h3>
                <input type="text" id="cnic-no" placeholder="4xxxx-xxxxxxx-x" maxlength="15" inputmode="numeric">
            </div>
            <div class="but-search">
                <button onclick="generateCard()">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    search
                </button>
            </div>
        </div>
    </section>

    <!-- section 3 -->

    <section>
        <div id="error-message"
            style="display: none; text-align: center; color: red; font-size: 1.5rem; margin-top: -4rem; font-weight: bold;">
            Your CNIC does not match
        </div>

        <div class="cards" id="card-container" style="display: none;">
            <div class="card">

                <div class="top">

                    <img src="assest/ChatGPT_Image_Feb_22__2026__12_18_51_PM-removebg-preview (1).png"
                        alt="School Logo">
                    <div class="curve"></div>
                </div>

                <div class="profile">
                    <img src="" id="profile-img">
                </div>

                <div class="info">
                    <p><strong>Name:</strong> <span id="card-name"></span></p>
                    <p><strong>Father:</strong> <span id="card-father"></span></p>
                    <p><strong>Roll No:</strong> <span id="card-roll"></span></p>
                    <p><strong>ID No:</strong> <span id="card-id"></span></p>
                    <p><strong>Course:</strong> <span id="card-course"></span></p>
                    <p><strong>Batch no:</strong> <span id="card-batch"></span></p>
                </div>

                <div class="decoration"></div>

            </div>

            <div class="card" style="margin-bottom: 3rem;">

                <div class="back-header">
                    ID VERIFICATION
                </div>

                <div class="back">
                    <div id="qrcode"></div>
                    <div class="scan-text">SCAN TO VERIFY</div>
                </div>

            </div>
        </div>

        <div class="down" id="download-btn-container" style="display: none;">
            <button class="download" onclick="downloadPDF()">
                download
            </button>
        </div>

    </section>


</body>

<script src="script.js"></script>
<script>
    function generateCard() {
      try {
        const cnicInput = document.getElementById('cnic-no').value;
        
        const allRegistrations = JSON.parse(localStorage.getItem('allRegistrations')) || [];
        const matchingUsers = allRegistrations.filter(user => user.cnic === cnicInput);
        let storedData = matchingUsers.length > 0 ? matchingUsers[matchingUsers.length - 1] : null;

        if (!storedData) {
            const sessionData = JSON.parse(localStorage.getItem('registrationData'));
            if (sessionData && sessionData.cnic === cnicInput) storedData = sessionData;
        }

        const cardContainer = document.getElementById('card-container');
        const errorMessage = document.getElementById('error-message');
        const qrCodeContainer = document.getElementById('qrcode');
        const downloadBtn = document.getElementById('download-btn-container');

        cardContainer.style.display = 'none';
        errorMessage.style.display = 'none';
        downloadBtn.style.display = 'none';

        if (!cnicInput) {
            alert("Please enter CNIC Number");
            return;
        }

        if (storedData) {
            // Check if numbers already exist, otherwise generate and save them
            let batchNo = storedData.batchNo;
            let rollNo = storedData.rollNo;
            let idNo = storedData.idNo;

            if (!batchNo || !rollNo || !idNo) {
                batchNo = Math.floor(Math.random() * 90) + 10; // Random 2 digit (e.g., 91)
                rollNo = Math.floor(Math.random() * 90000) + 10000; // Random 5 digit (e.g., 52389)
                 
                const r1 = Math.floor(Math.random() * 900) + 100;
                const r2 = Math.floor(Math.random() * 900) + 100;
                const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                const rAlpha = alpha[Math.floor(Math.random() * 26)] + alpha[Math.floor(Math.random() * 26)] + alpha[Math.floor(Math.random() * 26)];
                idNo = `${r1}-${rAlpha}-${r2}`;
                
                // Save to localStorage so they persist
                storedData.batchNo = batchNo;
                storedData.rollNo = rollNo;
                storedData.idNo = idNo;
                
                if (matchingUsers.length > 0) {
                    localStorage.setItem('allRegistrations', JSON.stringify(allRegistrations));
                } else {
                    localStorage.setItem('registrationData', JSON.stringify(storedData));
                }
            }

            // Populate Card
            document.getElementById('card-name').innerText = storedData.fullName || '';
            document.getElementById('card-father').innerText = storedData.fatherName || '';
            document.getElementById('card-course').innerText = storedData.course || '';
            document.getElementById('card-batch').innerText = batchNo;
            document.getElementById('card-roll').innerText = rollNo;
            document.getElementById('card-id').innerText = idNo;

            if (storedData.imageData) {
                document.getElementById('profile-img').src = storedData.imageData;
            } else {
                document.getElementById('profile-img').src = "assest/ChatGPT_Image_Feb_9__2026__01_04_36_PM-removebg-preview.png";
            }

            // Generate QR Code
            qrCodeContainer.innerHTML = "";
            if (typeof QRCode !== 'undefined') {
                new QRCode(qrCodeContainer, {
                    text: `ID: ${idNo}\nName: ${storedData.fullName}\nFather: ${storedData.fatherName}\nCourse: ${storedData.course}`,
                    width: 100,
                    height: 100
                });
            }

            cardContainer.style.display = 'flex';
            downloadBtn.style.display = 'flex';
        } else {
            errorMessage.style.display = 'block';
        }
      } catch (e) {
          console.error(e);
          alert("Error generating card: " + e.message);
      }
    }

    function downloadPDF() {
        if (typeof html2pdf === 'undefined') {
            alert("PDF library not loaded. Please check your internet connection.");
            return;
        }
        const element = document.getElementById('card-container');
        const opt = {
            margin: 10,
            filename: 'FSI_ID_Card.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>

</html>